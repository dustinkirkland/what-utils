#!/bin/sh
#
#    how-many-source - how many source packages in Ubuntu or Wolfi
#
#    Copyright (C) 2016 Dustin Kirkland <kirkland@ubuntu.com>
#    Copyright (C) 2023 Dustin Kirkland <dustin.kirkland@gmail.com>
#
#    Authors:
#        Dustin Kirkland <kirkland@ubuntu.com>
#        Dustin Kirkland <kirkland@chainguard.dev>
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.

. /etc/os-release 2>/dev/null || true
release=$VERSION_CODENAME
VERBOSE=0
for i in $@; do
	case "$i" in
		-r|--release)
			release="$2"
			shift 2
		;;
		-v|--verbose)
			VERBOSE=1
			shift
		;;
	esac
done

dir=$(mktemp -d)
trap "rm -rf ${dir}" HUP INT QUIT ILL TRAP KILL BUS TERM
cd "$dir"

case "$NAME" in
	Ubuntu|ubuntu)
		for i in main universe restricted multiverse; do
			u="http://archive.ubuntu.com/ubuntu/dists/$release/$i/source/Sources.gz"
			wget -q -O $i.gz "$u" >/dev/null 2>&1
		done
		if [ "$VERBOSE" = "1" ]; then
			zgrep "^Package:" * | sort -u
		fi
		zgrep "^Package:" * | sort -u | wc -l
	;;
	Wolfi|wolfi)
		git clone --depth=1 --quiet https://github.com/wolfi-dev/os.git
		if [ "$VERBOSE" = "1" ]; then
			grep -r "^package:" . | awk -F ":" '{print $1}' | sort -u | sed -e "s:^\.\/::"
		fi
		grep -r "^package:" . | awk -F ":" '{print $1}' | sort -u | wc -l
	;;
esac
rm -rf ${dir}
